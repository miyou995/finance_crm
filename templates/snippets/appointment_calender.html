<div class="card h-md-100">
    <div class="card-header border-0 pt-5">
        <h3 class="card-title align-items-start flex-column">
            <span class="card-label fw-bold text-gray-900">Rendez-vous aujourd'hui</span>
            <span class="text-muted mt-1 fw-semibold fs-7">Total {{ appointments|length }} rendez-vous</span>
        </h3>
        {% comment %} <div class="card-toolbar">
            <a href="#" class="btn btn-sm btn-light">Report Center</a>
        </div> {% endcomment %}
    </div>
    <div class="card-body pt-7 px-0">
        <ul class="nav nav-stretch nav-pills nav-pills-custom nav-pills-active-custom d-flex justify-content-between mb-8 px-5">
            {% for day in days %}
                <li class="nav-item p-0 ms-0">
                    <a class="nav-link btn d-flex flex-column flex-center rounded-pill min-w-45px py-4 px-3 btn-active-danger {% if forloop.first %}active{% endif %}" 
                       data-bs-toggle="tab" 
                       href="#kt_timeline_widget_3_tab_content_{{ forloop.counter }}">
                        <span class="fs-7 fw-semibold">{{ day|date:"D" }}</span>
                        <span class="fs-6 fw-bold">{{ day|date:"d" }}</span>
                    </a>
                </li>
            {% endfor %}
        </ul>
        <div class="tab-content mb-2 px-9">
            {% for day in days %}
                <div class="tab-pane fade {% if forloop.first %}show active{% endif %} overflow-y-auto" 
                        id="kt_timeline_widget_3_tab_content_{{ forloop.counter }}"
                        style="max-height: 400px;">
                        {% for appointment in appointments %}
                            {% if appointment.date.date == day %}
                                <div class="d-flex align-items-center mb-6 p-4 rounded shadow-sm bg-light-hover transition">
                                    <!-- State Bullet -->
                                    <span data-kt-element="bullet"
                                          class="bullet bullet-vertical d-flex align-items-center min-h-70px mh-100 me-4 bg-{{ appointment.get_state_color }} rounded-circle shadow-sm"></span>
                                    <!-- Appointment Details -->
                                    <div class="flex-grow-1 me-5">
                                        <div class="d-flex align-items-center mb-1">
                                            <span class="text-gray-900 fw-bold fs-4">{{ appointment.date|date:"H:i" }}</span>
                                            <span class="text-gray-500 fw-semibold fs-7 ms-2">{{ appointment.date|date:"A" }}</span>
                                            {% if appointment.state %}
                                                <span class="badge badge-outline badge-{{ appointment.get_state_color }} fs-5 ms-3 px-3 py-1 rounded-pill">
                                                    {{ appointment.get_state_display }}
                                                </span>
                                            {% endif %}
                                        </div>
                                        <div class="text-gray-700 fw-semibold fs-6 mb-2">{{ appointment.subject }}</div>
                                        <div class="d-flex flex-wrap align-items-center gap-2 mt-2">
                                            {% if appointment.b2b_lead %}
                                                <span class="badge badge-light-primary px-2 py-1 rounded-pill d-flex align-items-center">
                                                    <i class="bi bi-briefcase me-1"></i>
                                                    <span>Opportunité:</span>
                                                    <a href="#" class="text-primary fw-semibold text-decoration-underline ms-1">{{ appointment.b2b_lead }}</a>
                                                    {% if appointment.b2b_lead.company %}
                                                        <span class="ms-1 text-muted">({{ appointment.b2b_lead.company }})</span>
                                                    {% endif %}
                                                </span>
                                            {% endif %}
                                            {% if appointment.b2c_lead %}
                                                <span class="badge badge-light-primary px-2 py-1 rounded-pill d-flex align-items-center">
                                                    <i class="bi bi-person-badge me-1"></i>
                                                    <span>Opportunité:</span>
                                                    <a href="#" class="text-primary fw-semibold text-decoration-underline ms-1">{{ appointment.b2c_lead }}</a>
                                                    {% if appointment.b2c_lead.contact %}
                                                        <span class="ms-1 text-muted">({{ appointment.b2c_lead.contact }})</span>
                                                    {% endif %}
                                                    {% if appointment.b2c_lead.company %}
                                                        <span class="ms-1 text-muted">({{ appointment.b2c_lead.company }})</span>
                                                    {% endif %}
                                                </span>
                                            {% endif %}
                                            {% if appointment.users.exists %}
                                                <span class="badge badge-light-info px-2 py-1 rounded-pill d-flex align-items-center">
                                                    <i class="bi bi-people me-1"></i>
                                                    <span>Participants:</span>
                                                    {% for user in appointment.users.all %}
                                                        <a href="{% url 'users:detail_user' user.pk %}" class="text-info fw-semibold text-decoration-underline ms-1">{{ user.get_full_name|default:user.username }}</a>{% if not forloop.last %}, {% endif %}
                                                    {% endfor %}
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <!-- Edit Button -->
                                    <a class="btn btn-icon btn-light btn-sm ms-3"
                                       hx-get="{% url 'appointment:update_appointment' appointment.pk %}"
                                       data-bs-toggle="modal"
                                       data-bs-target="#kt_modal"
                                       data-bs-placement="right"
                                       data-bs-toggle="tooltip"
                                       hx-target="#kt_modal_content"
                                       hx-swap="innerHTML"
                                       title="{% translate 'modifier' %}">
                                        <i class="ki-duotone ki-notepad-edit fs-2x">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                        </i>
                                    </a>
                                </div>
                            {% endif %}
                        {% endfor %}
                </div>
            {% endfor %}
        </div>
       
    </div>
</div>