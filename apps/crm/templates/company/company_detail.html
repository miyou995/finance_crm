{% extends "layout/base.html" %}
{% load custom_filters %}
{% load static %}
{% load i18n %}
{% load render_table from django_tables2 %}
{% block content %}

<div class="d-block d-xl-flex justify-content-between align-items-end mb-4">
    {% include 'snippets/_breadcrumb.html' %}
    <div class="d-md-flex align-items-end gap-2">
        {% if perms.transactions.add_clientpayment %}
            <a class="btn btn-sm btn-success"
                hx-get="{% url 'transactions:create_company_clientpayment' company.pk %}"
                hx-target="#kt_modal_content"
                hx-swap="innerHTML"
                data-bs-toggle="modal"
                data-bs-target="#kt_modal"
                >
                <i class="ki-solid ki-dollar fs-2"></i>
                <span class="fw-semibold">{% trans 'Payer Facture' %}</span>    
            </a>
        {% endif %}
        {% if perms.transactions.add_clientpayment %}
            <a class="btn btn-sm btn-primary"
                hx-get="{% url 'transactions:create_company_quote_payment' company.pk %}"
                hx-target="#kt_modal_content"
                hx-swap="innerHTML"
                data-bs-toggle="modal"
                data-bs-target="#kt_modal"
                >
                <i class="ki-solid ki-dollar fs-2"></i>
                <span class="fw-semibold">{% trans 'Payer Autre Document' %}</span>    
            </a>
        {% endif %}
        {% if perms.crm.change_company %}
            <a  
                href="#" 
                class="btn btn-primary btn-sm"
                data-bs-toggle="modal" 
                data-bs-target="#kt_modal"
                data-bs-placement="right" 
                data-bs-toggle="tooltip" 
                hx-target="#kt_modal_content" 
                hx-get="{% url 'crm:update_company' object.pk %}"
                hx-swap="innerHTML">
                <i class="ki-solid ki-notepad-edit fs-2"></i> 
                {% translate "Modifier" %}
            </a>
        {% endif %}
        {% if perms.crm.delete_company %}
            <a  class="btn btn-sm btn-danger"
                hx-get="{% url 'crm:delete_company' company.pk %}"
                hx-target="#delete_modal_body"
                hx-swap="innerHTML"
                data-bs-toggle="modal"
                data-bs-target="#delete_modal"
                >
                <i class="ki-solid ki-trash fs-2"></i> 
                {% translate "Supprimer" %}
            </a>
        {% endif %}
        {% if perms.crm.add_contact %}
            <a class="btn btn-sm btn-dark"
                hx-get="{% url 'crm:create_company_contacts' company.pk %}"
                hx-target="#kt_modal_content"
                hx-swap="innerHTML"
                data-bs-toggle="modal"
                data-bs-target="#kt_modal"
            >
                <i class="ki-duotone ki-plus fs-2"></i>
                {% translate "Contact" %}
            </a>
        {% endif %}
        {% if perms.leads.add_b2blead %}
            <a  class="btn btn-sm btn-info"
                hx-get="{% url 'leads:create_company_b2blead' company.pk %}"
                hx-target="#kt_modal_content"
                hx-swap="innerHTML"
                data-bs-toggle="modal"
                data-bs-target="#kt_modal"
                >
                <i class="ki-duotone ki-plus fs-2"></i>
                {% translate "Opportunité" %}    
            </a>
        {% endif %}
        {% if perms.billing.add_invoice %}
            <a class="btn btn-sm btn-warning"
                hx-get="{% url 'billing:create_company_invoice' company.pk %}"
                hx-target="#kt_modal_content"
                hx-swap="innerHTML"
                data-bs-toggle="modal"
                data-bs-target="#kt_modal"
            >
                <i class="ki-duotone ki-plus fs-2"></i>
                {% translate "Facture" %}
            </a>
        {% endif %}
        {% comment %} {% if perms.billing.add_clientpayment %}
            <a class="btn btn-sm btn-warning"
                hx-get="{% url 'billing:create_company_clientpayment' company.pk %}"
                hx-target="#kt_modal_content"
                hx-swap="innerHTML"
                data-bs-toggle="modal"
                data-bs-target="#kt_modal"
            >
                <i class="ki-duotone ki-plus fs-2"></i>
                {% translate "Facture" %}
            </a>
        {% endif %} {% endcomment %}
        {% if perms.billing.add_quote %}
            <a class="btn btn-sm btn-secondary"
                hx-get="{% url 'billing:create_company_quote' company.pk %}"
                hx-target="#kt_modal_content"
                hx-swap="innerHTML"
                data-bs-toggle="modal"
                data-bs-target="#kt_modal"
            >
                <i class="ki-duotone ki-plus fs-2"></i>
                {% translate "Devis" %}
            </a>
        {% endif %}
        {% if perms.crm.add_company %}
            <a class="btn btn-sm btn-outline btn-outline-dashed btn-outline-primary btn-active-light-primary"
                hx-get="{% url 'crm:create_companydocument' company.pk %}"
                hx-target="#kt_modal_content"
                hx-swap="innerHTML"
                data-bs-toggle="modal"
                data-bs-target="#kt_modal"
            >
                <i class="ki-duotone ki-plus fs-2"></i>
                {% translate "Documents" %}
            </a>
        {% endif %}
    </div>
</div>
<div class="d-flex flex-column flex-lg-row">
    <div class="flex-column flex-lg-row-auto w-lg-250px w-xl-300px mb-10">
        <div class="card mb-5 mb-xl-8">
            <div class="card-body">
                <div class="d-flex flex-center flex-column py-5">
                    {% if company.logo %}
                        <div class="symbol symbol-75px symbol-circle mb-5">
                            <img src="{{ company.logo.url }}" alt="{{ company.name }}" />
                        </div>
                    {% else %}
                        <div class="symbol symbol-75px symbol-circle mb-5">
                            <div class="symbol-label fs-2 fw-semibold text-danger text-uppercase">{{company.name|slice:2 }}</div>
                        </div>
                        {% endif %}
                        <a href="{{ company.get_absolute_url }}" class="fs-3 text-gray-800 text-hover-primary fw-bold mb-3">{{ company.name }}</a>
                    <div class="mb-3">
                        <div class="badge badge-lg badge-light-primary d-inline">{{ company.leads.first.current_state_user|default:"NON AFFECTE" }}</div>
                    </div>
                     <div class="fw-bold mb-3">
                        {% for sector in company.activity_sectors.all %}
                            <span class="badge badge-light-info mb-1">{{ sector }}</span>
                        {% empty %}
                            <span class="text-muted">{% translate "Pas de secteur d'activité" %}</span>
                        {% endfor %}
                    </div>
                    <div class="d-flex flex-wrap flex-center">
                          <div class="border border-gray-300 border-dashed rounded py-3 px-3 mb-3" data-bs-toggle="tooltip" data-bs-placement="bottom" title="{% translate 'Categorie de segment' %}">
                            <div class="fs-4 fw-bold text-gray-700">
                                <span class="w-50px">{{ company.potentiel.segment|default:'-' }} </span>
                            </div>
                            <div class="fw-semibold text-muted">{% translate "CAT" %}</div>
                        </div>
                        <div class="border border-gray-300 border-dashed rounded py-3 px-3 mb-3" data-bs-toggle="tooltip" data-bs-placement="bottom" title="{% translate 'CA réalisé cette année' %}">
                            <div class="fs-4 fw-bold text-gray-700">
                                <span class="w-75px">{{ company.projects_count|default:'0' }}</span>
                            </div>
                            <div class="fw-semibold text-muted">{% translate "Réalisé" %}</div>
                        </div>
                        <div class="border border-gray-300 border-dashed rounded py-3 px-3 mx-4 mb-3">
                            <div class="fs-4 fw-bold text-gray-700">
                                <span class="w-50px">{{ company.annual_goal|default:'0' }} {% translate "DA" %}</span>
                            </div>
                            <div class="fw-semibold text-muted">{% translate "Objectif" %}</div>
                        </div>
                    </div>
                </div>

                {% for tag in company.tags.all %}
                    <span class="badge badge-light-info mb-1">{{ tag }}</span>
                {% empty %}
                    <span class="text-muted">{% translate "Pas de tags" %}</span>
                {% endfor %}
                    
                <div class="separator"></div>

                <div class="pb-5 fs-6">
                    <div class="fw-bold mt-5">{% translate "Téléphone" %}</div>

                    {% for phone in company.phones.all %}
                        <div class="text-gray-600"><a href="tel:{{ phone }}">{{ phone }}</a></div>
                    {% endfor %}
                        
                     <div class="fw-bold mt-5">{% translate "Email" %}</div>

                    {% for email in company.emails.all %}
                        <div class="text-gray-600"><a href="mailto:{{ email }}">{{ email }}</a></div>
                    {% endfor %}
    
                {% block related_data %}

                    {% if company.business_owner %}
                        <div class="fw-bold mt-5">{% translate "Gérant" %}</div>
                        <div class="text-gray-600">{{ company.business_owner }}</div>
                    {% endif %}

                    <div class="fw-bold mt-5">{% get_verbose_field_name company "annual_tax" %}</div>
                    <div class="text-gray-600">
                        {{ company.annual_tax|default:"-" }} <span class="text-muted">{% translate "DA" %}</span>
                    </div>

                    <div class="fw-bold mt-5">{% get_verbose_field_name company "annual_goal" %}</div>
                    <div class="text-gray-600">
                        <a href="#" class="text-gray-600 text-hover-primary">{{ company.annual_goal|default:"N/A" }}  <span class="text-muted">{% translate "DA" %}</span></a>
                    </div>

                    <div class="fw-bold mt-5">{% get_verbose_field_name company "address" %}</div>
                    <div class="text-gray-600">
                        {{ company.address|default:"N/A" }}
                    </div>

                    <div class="fw-bold mt-5">{% get_verbose_field_name company "employees_count" %}</div>
                    <div class="text-gray-600">{{ company.employees_count|default:"0" }}</div>
                {% endblock related_data %}
                    
                    <div class="fw-bold mt-5">{% translate "Wilaya" %}</div>
                    <div class="text-gray-600">{{ company.wilaya|default:"N/A" }}</div>

                    <div class="fw-bold mt-5">{% translate "Commune" %}</div>
                    <div class="text-gray-600">{{ company.commune|default:"N/A" }}</div>
                </div>
                <div class="separator"></div>
                <div class="d-flex flex-stack fs-4 py-3">
                    <div class="fw-bold rotate collapsible" 
                        role="button" 
                        data-bs-toggle="collapse" 
                        href="#fiscale-data-collapsed" 
                        aria-expanded="false" 
                        aria-controls="fiscale-data-collapsed"
                    >
                        {% translate "Coordonnés Fiscaux" %} 
                    <span class="ms-2 rotate-180">
                        <i class="ki-outline ki-up fs-3"></i>
                    </span></div>
                    {% if perms.crm.add_company %}
                        <a  class="btn btn-sm btn-primary"
                            hx-get="{{ update_url }}"
                            hx-target="#kt_modal_content"
                            hx-swap="innerHTML"
                            data-bs-toggle="modal"
                            data-bs-target="#kt_modal"
                        >
                            <i class="ki-duotone ki-plus fs-2"></i>
                        </a>
                    {% endif %}
                </div>
                <div id="fiscale-data-collapsed" class="collapse">
                    <div class="pb-5 fs-6">
                        <div class="fw-bold mt-5">{% trans "Capitale" %}</div>
                        <div class="text-gray-600">{{ company.capital|default:"-" }}</div>

                        <div class="fw-bold mt-5">{% trans "Banque" %}</div>
                        <div class="text-gray-600">{{ company.bank_name|default:"-" }}</div>

                        <div class="fw-bold mt-5">{% trans "NIF" %}</div>
                        <div class="text-gray-600">{{ company.nif|default:"-" }}</div>
                       
                          <div class="fw-bold mt-5">{% trans "NIS" %}</div>
                        <div class="text-gray-600">{{ company.nis|default:"-" }}</div>

                          <div class="fw-bold mt-5">{% trans "N° Article" %}</div>
                        <div class="text-gray-600">{{ company.nart|default:"-" }}</div>

                          <div class="fw-bold mt-5">{% trans "N° RC" %}</div>
                        <div class="text-gray-600">{{ company.nrc|default:"-" }}</div>

                    </div>
                </div>
                {% comment %} <div class="separator"></div>
                <div class="d-flex flex-wrap gap-2 mt-3">
                    {% if company.facebook %}
                        <a href="{{ company.facebook }}" target="_blank"  data-bs-toggle="tooltip" title="Facebook">
                            <i class="bi bi-facebook fs-2x"></i>
                        </a>
                    {% endif %}
                    {% if company.twitter %}
                        <a href="{{ company.twitter }}" target="_blank"  data-bs-toggle="tooltip" title="Twitter">
                            <i class="bi bi-twitter fs-2x"></i>
                        </a>
                    {% endif %}
                    {% if company.linkedin %}
                        <a href="{{ company.linkedin }}" target="_blank"  data-bs-toggle="tooltip" title="LinkedIn">
                            <i class="bi bi-linkedin fs-2x"></i>
                        </a>
                    {% endif %}
                    {% if company.instagram %}
                        <a href="{{ company.instagram }}" target="_blank"  data-bs-toggle="tooltip" title="Instagram">
                            <i class="bi bi-instagram fs-2x"></i>
                        </a>
                    {% endif %}
                    {% if company.youtube %}
                        <a href="{{ company.youtube }}" target="_blank"  data-bs-toggle="tooltip" title="YouTube">
                            <i class="bi bi-youtube fs-2x"></i>
                        </a>
                    {% endif %}
                    {% if not company.facebook and not company.twitter and not company.linkedin and not company.instagram and not company.youtube %}
                        <span class="text-muted">{% trans "Aucun lien social" %}</span>
                    {% endif %}
                </div> {% endcomment %}
            </div>
        </div>
    </div>
    <!-- Right Side: Tabs -->
    <div class="card flex-fill">
        <div id="kt_app_content" class="card-body">
            <div id="kt_app_content_container" class="app-container container-fluid">
                <ul class="nav nav-custom nav-tabs nav-line-tabs nav-line-tabs-2x border-0 fs-4 fw-semibold mb-8">
                    {% if perms.transactions.view_clientpayment %}
                        <li class="nav-item">
                            <a class="nav-link pb-4 active" data-bs-toggle="tab" href="#kt_view_overview_tab">
                                {% translate "Aperçu" %} 											
                            </a>
                        </li>
                    {% endif %}
                    {% if perms.crm.view_contact %}
                        <li class="nav-item">
                            <a class="nav-link pb-4" data-bs-toggle="tab" href="#kt_view_contacts_tab">
                                {% translate "Contacts" %} 											
                                <span class="badge badge-secondary">{{ contacts_count }}</span>
                            </a>
                        </li>
                    {% endif %}
                    {% if perms.leads.view_b2blead %}
                    <li class="nav-item">
                        <a class="nav-link pb-4" data-kt-countup-tabs="true" data-bs-toggle="tab" href="#kt_view_overview_prospects">
                            {% translate "Opportunités" %} 											
                            <span class="badge badge-secondary">{{ leads_count }}</span>
                        </a>
                    </li>
                    {% endif %}
                    {% if perms.billing.view_quote %}
                        <li class="nav-item">
                            <a class="nav-link pb-4" data-bs-toggle="tab" href="#kt_view_quotes_tab">
                                {% translate "Devis" %} 											
                                <span class="badge badge-secondary">{{ quotes_count }}</span>
                            </a>
                        </li>
                    {% endif %}
                    {% if perms.billing.view_invoice %}
                        <li class="nav-item">
                            <a class="nav-link pb-4" data-bs-toggle="tab" href="#kt_view_invoices_tab">
                                {% translate "Factures" %} 											
                                <span class="badge badge-secondary">{{ invoices_count }}</span>
                            </a>
                        </li>
                    {% endif %}
                    {% if perms.transactions.view_clientpayment %}
                        <li class="nav-item">
                            <a class="nav-link pb-4" data-bs-toggle="tab" href="#kt_view_paiements_tab">
                                {% translate "Paiements" %} 											
                                <span class="badge badge-secondary">{{ payments_count }}</span>
                            </a>
                        </li>
                    {% endif %}
                    <li class="nav-item">
                        <a class="nav-link pb-4" data-bs-toggle="tab" href="#kt_view_documents_tab">
                            {% translate "Documents" %} 											
                            <span class="badge badge-secondary">{{ documents_count }}</span>
                        </a>
                    </li>
                 
                </ul>
                <!-- Tab Content Placeholder -->
                <div class="tab-content">
                    {% if perms.transactions.view_clientpayment %}
                        <div class="tab-pane fade show active" id="kt_view_overview_tab">
                            <div class="table-responsive table-container"
                                hx-get="{% url 'crm:charts_company' company.pk %}"
                                hx-trigger="refresh_table from:body, load"
                                hx-swap="innerHTML"
                                hx-target="this"
                            >
                            </div> 
                        </div>
                    {% endif %}
                    {% if perms.crm.view_contact %}
                        <div class="tab-pane fade" id="kt_view_contacts_tab">
                            <div class="table-responsive table-container"
                                hx-get="{% url 'crm:company_contacts' company.pk %}"
                                hx-trigger="refresh_table from:body, load"
                                hx-swap="innerHTML"
                                hx-target="this"
                            >
                            </div>
                        </div>
                    {% endif %}
                    {% if perms.leads.view_b2blead %}
                        <div class="tab-pane fade" id="kt_view_overview_prospects">
                            <div class="table-responsive table-container"
                                hx-get="{% url 'leads:company_leads' company.pk %}"
                                hx-trigger="refresh_table from:body, load"
                                hx-swap="innerHTML"
                                hx-target="this"
                            >
                            </div>
                        </div>
                    {% endif %}
                    {% if perms.billing.view_quote %}
                        <div class="tab-pane fade" id="kt_view_quotes_tab">
                            <div class="table-responsive table-container"
                                hx-get="{% url 'billing:company_quotes' company.pk %}"
                                hx-trigger="refresh_table from:body, load"
                                hx-swap="innerHTML"
                                hx-target="this"
                            >
                            </div>
                        </div>
                    {% endif %}
                    {% if perms.billing.view_invoice %}
                        <div class="tab-pane fade" id="kt_view_invoices_tab">
                            <div class="table-responsive table-container"
                                hx-get="{% url 'billing:company_invoices' company.pk %}"
                                hx-trigger="refresh_table from:body, load"
                                hx-swap="innerHTML"
                                hx-target="this"
                            >
                            </div>
                        </div>
                    {% endif %}
                    {% if perms.transactions.view_clientpayment %}
                        <div class="tab-pane fade" id="kt_view_paiements_tab">
                            <div class="table-responsive table-container"
                                hx-get="{% url 'transactions:company_invoices_payment' company.pk %}"
                                hx-trigger="refresh_table from:body, load"
                                hx-swap="innerHTML"
                                hx-target="this"
                            >
                            </div>
                        </div>
                    {% endif %}
                    <div class="tab-pane fade" id="kt_view_documents_tab">
                        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                            {% for doc in documents %}
                                <div class="col">
                                    <div class="card h-100 shadow-sm border-0">
                                        <div class="card-body d-flex flex-column">
                                            <div class="mb-3">
                                                <i class="ki-solid ki-file fs-1 text-primary"></i>
                                            </div>
                                            <h6 class="card-title mb-2">
                                                <a href="{{ doc.document.url }}" target="_blank" class="text-primary text-hover-underline">
                                                    {{ doc.document.name|cut:"documents/"|cut:"/"|default:"Document" }}
                                                </a>
                                            </h6>
                                            <p class="card-text text-muted small flex-grow-1">
                                                {{ doc.description|default:_("Aucune description") }}
                                            </p>
                                        </div>
                                        <div class="card-footer bg-transparent border-0 d-flex justify-content-between align-items-center px-3 py-2">
                                            <span class="text-muted small">
                                                {{ doc.document.size|filesizeformat }}
                                            </span>
                                            <div class="d-flex gap-2">
                                                <a href="{{ doc.document.url }}" class="btn btn-icon btn-sm btn-light-primary" download title="{% trans 'Télécharger' %}">
                                                    <i class="fa fa-download fs-2"></i>
                                                </a>
                                                <a class="btn btn-icon btn-sm btn-light-danger"
                                                    hx-get="{% url  'crm:delete_companydocument' doc.pk %}"
                                                    hx-target="#delete_modal_body"
                                                    hx-swap="innerHTML"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#delete_modal"
                                                >
                                                    <i class="ki-solid ki-trash fs-2"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% empty %}
                                <div class="col-12">
                                    <div class="alert alert-info text-center mb-0">
                                        {% trans "Aucun document trouvé pour cette entreprise." %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<input type="hidden" name="reload_page" value="true">

{% endblock content %}






















